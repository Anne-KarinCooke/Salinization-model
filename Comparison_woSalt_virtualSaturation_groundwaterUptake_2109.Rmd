---
title: 'Comparison w/o salt '
author: 'Anne-Karin Cooke'
output: html_document
---

# Important changes           
This version compares the impact of salt and no salt for dry and wet climates.
Here, also the osmotic factor fosm was NOT implemented in the Growth and the mortality function.

##Constants

Soil properties were derived from standard Australian soils in Neurotheta (Minasny and McBratney, 2002, as cited in Shah et al, 2011).

```{r Constants}
R= 0.0821 # gas constant [ L atm mol-1 K-1 ]
Temp= 298 # temperature in Kelvin,  25 degrees Celsius
Mm= 58.44 # molar mass of NaCl in g/mol


# SOIL INPUT - medium heavy Clay
# n<-0.4473
# s_fc<-0.3936/n # Field capacity
# Hydraulic conductivity
# K_s<-2.82*10 # mm/day

#Z =614.25
Z =100 # cm GROUNDWATER DEPTH

#Coarse Sand

# Campbell's b
  b= 4.1152

n = 0.368 # porosity
  s_fc = 0.1895/n # Field capacity
# Hydraulic conductivity
  K_s = 182.68*10 # cm/day to mm/day

  psi_s_bar = -0.61E-3 
  h1bar =  -psi_s_bar 
  hb = psi_s_bar*-10^4
  Ep=10

soilpar <- list(b = b, n = n, s_fc = s_fc, K_s = K_s, 
                psi_s_bar = psi_s_bar, h1bar = h1bar, hb = hb, Ep=Ep)
    #................................................
    # Vegetation 1 (Grass)
    # paspalum secateum F-I and R-I, 2004
    # Gives only parameters
    #.................................................
    Zr = 40 # soil depth (cm)   Also Table 2...Fernandez-Illescas and Rodriguez-Iturbe...2001
    c_p=0.4
vegpar <- list(Zr = Zr, c_p=c_p)
```

## Infiltration function
```{r Infiltration}
Infil <- function(h,P, alpha_i=0.25, k=12, W0=0.2){
  
  I=alpha_i*h*(P+k*W0)/(P+k)
  
  return (I)
}
```

## Water uptake function
```{r WaterUptake}
par_in <- list(gmax=0.05, k1=5)
WU <- function(M,P,par=par_in){ 
# using Svir in here means scaling Svir back to M, easier to do at Svir in balances  
#  WU=par$gmax*((M*(1+Svir))/(((M*(1+Svir))+par$k1)))*P 
  WU=par$gmax*(M/((M+par$k1)))*P 
  
  return(WU)
}
```

## Plant growth function 
```{r Plantgrowth}
par_in$c=10

Gr <- function(M,P,par=par_in) { 
  
  Gr = par$c*WU(M,P,par)
  
  return(Gr)
}
```

## Plant mortality function 
```{r Mortality}
Mo <- function(P,M,Svir,d=0.1) {
  # needs to be M/Svir because both are "large" numbers
  # you want a number ~1 for multiplication, or <0.1 for addition
  Mo = P*(d*(M/Svir))
  
  return(Mo)
}
```

## G function (Eagelson 1978)
```{r Gfunction}
G <- function(b,hb,Z) {
  b1 <- 2+3/b
  a1 <- 1+(3/2)/(b1-1)
  H1 <- a1*(hb/Z)^b1
  return(H1)
}
# test
G(b=soilpar$b,hb=soilpar$hb, Z=Z)

```


```{r VerticalFlux}
#******************************************
L_n <- function(M,Z,P,soilpar,vegpar) {
   Zr <- vegpar$Zr
   hb <- soilpar$psi_s_bar*-10^4
   #browser()
   soilpar$s_fc <- (Z/hb)^(-1/soilpar$b)


  s=M/(soilpar$n*Zr)

  # capillary upflow
  G1 <- G(soilpar$b,hb,Z) # using the G function 
  u_set <- s[s < soilpar$s_fc]
  
 
    # UpT=G1*K_s*(1-exp(-c*P))*Ep
  

  u <- c(rep(G1*soilpar$K_s*(1-exp(-(vegpar$c_p*P)))*soilpar$Ep,length(u_set)),rep(0,(length(M)-length(u_set))))
   # u <- c(rep(G1*K_s,length(u_set)),rep(0,(length(M)-length(u_set))))
  # leaching
  #ifelse(soilpar$s_fc>n,soilpar$s_fc<-soilpar$s_fc,soilpar$s_fc<-n)
  l <- M*exp(-((soilpar$s_fc-M/(Zr*soilpar$n))*K_s/(Zr*soilpar$n)))
  
return(list(U=u,L=l))
}

# test
 M <- seq(0,10,length=100)
 Z <- 1000
plot(M,L_n(M,Z,P=10,soilpar=soilpar,vegpar=vegpar)$L,type="l",ylim=c(0,3))
lines(M,L_n(M,Z,P=2,soilpar=soilpar,vegpar=vegpar)$U,col="red")
```

## Leaching function 
```{r OldLeaching}
# L <- function(M,K_s,s_fc,Zr_in=Zr,n_1=n) {
#   
#   L=M*exp(-((s_fc-M/(Zr_in*n_1))*K_s/(Zr_in*n_1)))
#   
#   return(L)
# }

```

## Soil moisture and salt balance 
```{r balances}
 balances <- function(Rain, par=par_in,plotit=F,
                      soilpar,
                      vegpar,
                      f= 0.4, ConcConst = 0.1,  CM.gw = 5){
   
   # f is the soil salt leaching efficiency (whether some salt is retained)
   # ConcConst is the concentration of the salt in the infiltrating water
   # Storage vectors


# Storage vectors for the daily steps are initialized.


   M <- rep(0,length(Rain)) # soil moisture [mm]
   h <- rep(0,length(Rain)) # infiltration depth [mm]
   P <- rep(0,length(Rain)) #biomass density []
   CM<- rep(0,length(Rain)) # Salt concentration in soil water in g/L or g/mm
   SmI<- rep(0,length(Rain)) # Salt mass in infiltrating water [g]
   SmM <- rep(0,length(Rain)) # Salt mass in soil water [g]
   In <- rep(0,length(Rain)) # infiltration [mm]
# Leach <- rep(0,length(Rain)) # leaching [mm]
   Svir <- rep(0,length(Rain)) # virtual saturation
  
   L<- rep(0,length(Rain))
   U<- rep(0,length(Rain))


# Initial values to start the simulation.

   
   M[1] <- 3
   h[1] <- 10 
   P[1] <- 3
   CM[1]<- 0
   Svir[1] <- M[1]


# We decided to split the numerical calculations for the daily into 12 substeps.

   deltat <- 12 # split in 12 increments

  
# Storage vectors for the substeps are initialized.

   M_sub <- rep(0,deltat)
   h_sub <- rep(0,deltat)
   I_sub <- rep(0,deltat)
   #Q_sub <- rep(0,deltat)
   WU_sub <-rep(0,deltat) # Water uptake in mm
   P_sub <- rep(0,deltat) 
   Gr_sub <- rep(0,deltat) # Growth of biomass
   Mo_sub<- rep(0,deltat) # Mortality of biomass
   SmI_sub <- rep(0,deltat) 
   SmM_sub<- rep(0,deltat) 
   CM_sub<- rep(0,deltat) 
   # Posm_bar<- rep(0,deltat) # osmotic pressure of soil water in bar
   # fosm<- rep(0,deltat) # "osmotic factor", reduces available soil water to plant water uptake
   L_sub <- rep(0,deltat) # leaching
  Svir_sub <- rep(0,deltat) # virtual saturation

   L_sub<-rep(0,deltat) # calculates leakage loss without evaporation loss
   U_sub<-rep(0,deltat)

  
   timeincr= 1/deltat
   
  for (t in 2:length(Rain)){
    
    for (tt in 1:(deltat-1)) {
      
      h.old <- ifelse(tt==1,h[t-1],h_sub[tt])
      P.old <- ifelse(tt==1,P[t-1],P_sub[tt])
      M.old <- ifelse(tt==1,M[t-1],M_sub[tt])
      SmI.old <-ifelse(tt==1,SmI[t-1],SmI_sub[tt])
      CM.old <-ifelse(tt==1,CM[t-1],CM_sub[tt])
     Svir.old <-ifelse(tt==1,Svir[t-1],Svir_sub[tt])

# The impact of the the osmotic pressure is calculated using Van't Hoff's law. For that, molarity is calculated dividing the 
# concentration by the molar mass of NaCl (58.44 g/mol). The osmotic pressure is the product of molarity, universal gas constant and temperature in Kelvin.
# The wilting point is found at an pressure of -15 bar. 
# Between 0 and 15 bar, an "osmotic factor", scaled from 1 to 0, is added to the Water uptake function. At fosm = 0, not water uptake by plants is possoble.
#       Posm_bar[tt]= ((CM.old/Mm)*R*Temp)*1.01325
#       ifelse(Posm_bar[tt]<=15,fosm[tt] <- 1-(Posm_bar[tt]/15), fosm[tt] <- 0)    #fosm, osmotic factor

# Balance for water depth on soil

      h_sub[tt+1] <- h.old + ifelse(tt==1,Rain[t],0) - Infil(h.old, P.old)*timeincr

# Infiltration

      I_sub[tt] <- Infil(h.old, P.old)*timeincr

#  1. Update soil moisture with infiltration

      M_sub[tt + 1] <- M.old + I_sub[tt]      
      
# Now do all plant uptake and growth
# water uptake by plants: include infiltration in available water

       #M_sub[tt + 1] <- M_sub[tt] + Svir_sub[tt]

      WU_sub[tt] <- WU(M=Svir.old,P.old,par)*timeincr 
      
      # growth rate
      Gr_sub[tt] <- Gr(M=Svir.old, P.old,par)*timeincr 
      # Mortality
      Mo_sub[tt]<- Mo(P.old, M=M.old, Svir=Svir.old, d=par_in$d)*timeincr
      # calculate plant biomass balance
      P_sub[tt + 1] <- P.old + Gr_sub[tt]- Mo_sub[tt] 
      
      
# re-calculate water balance
# 2. before leaching
      M_sub[tt + 1] <- M.old + I_sub[tt] - WU_sub[tt] #- L_sub[tt] 

# Calculate salt concentration in the soil
      CM_sub[tt+1]<- SmM_sub[tt+1]/M_sub[tt + 1] 
#browser()
      # 3. calculate leaching amount
#       L_sub[tt] <- L(M_sub[tt+1], soilpar$K_s, soilpar$s_fc,soilpar$Zr,soilpar$n)*timeincr
#    L_sub[tt] <- L_n(M=M_sub[tt],Z=Z,soilpar=soilpar,vegpar=vegpar)$L
   L_sub[tt]<-do.call(L_n,list(M = M_sub[tt + 1], P = P_sub[tt + 1], Z = Z,
                               soilpar = soilpar,vegpar = vegpar))$L 
   
   U_sub[tt]<-do.call(L_n,list(M = M_sub[tt + 1],P = P_sub[tt + 1], Z = Z,
                               soilpar = soilpar, vegpar = vegpar))$U
   # U_sub[tt]<-do.call(L_n,list(M=M_sub[tt + 1],Z=Z,soilpar=soilpar,vegpar=vegpar))$U
      # 4. final adjust soil moisture for leaching
       M_sub[tt + 1] <- M_sub[tt + 1] - L_sub[tt]*timeincr + U_sub[tt]*timeincr

# calculate saltbalance
    L_salt <- CM.old*L_sub[tt]*timeincr
    U_salt <- CM.gw*U_sub[tt]*timeincr
       
      SmI_sub[tt+1]<- SmI.old + I_sub[tt]*ConcConst - L_salt
      SmM_sub[tt+1]<- SmI_sub[tt + 1] + U_salt ### I totally forgot to put U_salt here
       
#       SmGW_sub[tt+1] <- SmGW.old + L_salt - U_salt
      

#browser()
    # I have now scaled Svir to M  
    Svir_sub[tt + 1]<-soilpar$n*vegpar$Zr*((soilpar$h1bar)^(1/soilpar$b))*
                     ((soilpar$h1bar)*(M_sub[tt + 1]/
                       (soilpar$n*vegpar$Zr))^(-soilpar$b)
                       +(3.6*CM_sub[tt + 1]))^(-1/soilpar$b)

    } 
  
# Aggregating the substep results to daily values.

    P[t] = P_sub[deltat]
    M[t] = M_sub[deltat]
    h[t] = h_sub[deltat]
    CM[t] = CM_sub[deltat]
    SmM[t] = SmI[t] = SmM_sub[deltat]
    In[t]= I_sub[deltat]
    L[t] = L_sub[deltat]
    U[t] = U_sub[deltat]
    Svir[t] = Svir_sub[deltat]

}


# Plotting
 
if (plotit==T) {  
  plot(M, type="l",ylim=c(0,100),xlim=c(0,time),xlab=("time [d]"), main="with salt") # main=paste("lambda=", lambda[j],"alpha=", alpha[i]))
  points(Rain*10, type="h", col="skyblue")
   
    lines(Svir,type="l", col="blue")
    abline(h=0, col="Gray50",lwd=2,lty=2)

    lines(SmM,type="l", col="red")
    lines(CM,type="l", col="purple")
    lines(P,type="l", col="green")
  
  
#  legend("topright",cex=1, pt.cex=0.4, c("Moisture [mm]","Rainfall [mm]*10","overland flow depth[mm] ","salt mass in soil water [g]", "salt concentration in soil water [g/l]", "Plant biomass density [g/m^2]"),
#           col=c("black","skyblue","blue","red","purple","green"),lty=1)
#  

}

Out <- data.frame(P=P,M=M,h=h, CM=CM, SmM=SmM, In=In, L=L, U=U, Svir=Svir)
return(Out)
}
```

source the Moisture function script
source("MoistureFunction.R")
source("Rainfall.R")

## Rainfall function
```{r RainfallFunction}

Precip <- function(time,alpha,lambda,delta) {
  # generate a vector of times between rainfall events > delta
  f_P<-floor(rexp(time,lambda*exp(-delta/alpha))) # vector of times between rainfall occurrences (equation 4 & 8)
  # generate a binary vector from this (impulse function)
  binary.vec <- unlist(lapply(1:time,function(i) c(rep(0,f_P[i]),1)))
  R <- rexp(length(binary.vec),1/alpha)*binary.vec 
  return(R[1:time])
}
```

The generated rainfall is stored in a list to be used in further experiments.
```{r Rainlist}
# for (i in 1:length(alpha)) {
#   for (j in 1:length(lambda)) {
# Rainlist[[i]][[j]] <- list(Rain <- Precip(time,alpha[i],lambda[j],delta))
#     }
#   }
```

## Changing climates
Alpha and lambda are set as sequence of 10 different value. 
```{r VariableClimates}
alpha <- seq(0.6,1.5,by=0.1) 
lambda <- seq(0.1,1,by=0.1)

Store <- list()
sub_store <- list()
time <- 1000
delta <- 0
set.seed(1000)
```

This loop generates rainfall with the distribution properties alpha[i] and lambda[j].
For each alpha[i] and each lambda[j] the soil water balance function is executed and the results stored in a nested list.
```{r runClimateLoop}
# set the mortality value
par_in$d <- 0.05

for (i in 1:length(alpha)) {
  
for (j in 1:length(lambda)) {
    # generate the rainfall
    Rain <- Precip(time,alpha[i],lambda[j],delta)
    Rainlist <- data.frame(Precip(time,alpha[i],lambda[j],delta))
    
    sub_store[[j]] <-data.frame(alpha_o=rep(alpha[i],time),
                                lambda_o=rep(lambda[j],time),
                                balances(Rain,plotit=F, par=par_in,
                                soilpar=list(n=n, s_fc=s_fc, 
                                             K_s=K_s, psi_s_bar=psi_s_bar,
                                             h1bar=h1bar, b=b, Ep=Ep),
                                             vegpar=list(Zr=40, c_p=0.4)))
  }
  Store[[i]] <- sub_store
}
```


## Results

### Plotted climate combinations

clim1: lambda=0.1, alpha=0.6
clim2: lambda=1, alpha=0.6
clim3: lambda=0.5, alpha=1
clim4: lambda=0.1, alpha=1.5
clim5: lambda=1, alpha=1.5

```{r PlotClimatecombinations}
#with salt

clim1rain <- Precip(time,alpha=0.6,lambda=0.1,delta)
clim1 <- balances(Rain=clim1rain,plotit=T, soilpar=list(n=n,Zr=Zr, s_fc=s_fc, 
                                             K_s=K_s, psi_s_bar=psi_s_bar,
                                             h1bar=h1bar, b=b, Ep=Ep),
                                             vegpar=list(c_p=0.4,Zr=Zr))

# #without salt
# 
# # clim1 <- balances_woSalt(Rain=clim1rain,plotit=T, soilpar=list(K_s=K_s,n=n,Zr=Zr,s_fc=s_fc))
# 
# # clim2rain <- Precip(time,alpha=0.6,lambda=1,delta)
# # clim2 <- balances(Rain=clim2rain,plotit=T, soilpar=list(K_s=K_s,n=n,Zr=Zr,s_fc=s_fc))
# # clim3rain <- Precip(time,alpha=1,lambda=0.5,delta)
# # clim3 <- balances(Rain=clim3rain,plotit=T, soilpar=list(K_s=K_s,n=n,Zr=Zr,s_fc=s_fc))
# # clim4rain <- Precip(time,alpha=1.5,lambda=0.1,delta)
# # clim4 <- balances(Rain=clim4rain,plotit=T, soilpar=list(K_s=K_s,n=n,Zr=Zr,s_fc=s_fc))
# 
# #with salt
 clim5rain <- Precip(time,alpha=1.5,lambda=1,delta)
# clim5 <- balances(Rain=clim5rain,plotit=T, soilpar=list(K_s=K_s,n=n,Zr=Zr,s_fc=s_fc))
#  
# without salt
clim5 <- balances(Rain=clim5rain,plotit=T, soilpar=list(n=n,Zr=Zr, s_fc=s_fc, 
                                             K_s=K_s, psi_s_bar=psi_s_bar,
                                             h1bar=h1bar, b=b, Ep=Ep),
                                             vegpar=list(c_p=0.4,Zr=Zr))
```


Plotting M and P for different lambdas

```{r}
require(ggplot2)
lambda_sum <- do.call(rbind,Store[][[2]])
lambda_sum$time <- rep(1:time,length(lambda))

pl <- ggplot(lambda_sum,aes(x=time,y=P, colour="P (plant biomass density [gm-2])")) + geom_line()
pl  <- pl + geom_line(aes(x=time,y=M, colour="Moisture"))  
pl <- pl +  facet_wrap(~lambda_o, ncol=2)   #, colour=lambda_o (put this in aes-brackets) 
pl  + ggtitle("Plant biomass P and soilmoisture M for varying lambdas") +  geom_line(aes(x=time, y=SmM, colour= "S (soil salt mg/L")) + theme(plot.title = element_text(lineheight=.8, face="bold"))
```

Plotting Soil water salt concentration for different alphas and lambdas

```{r}
lambda_sum_all <- do.call(rbind,do.call(rbind,Store))
lambda_sum_all$time <- rep(rep(1:time,length(lambda)),length(alpha))


pa <- ggplot(lambda_sum_all,aes(x=time,y=SmM,col=as.factor(lambda_o))) + geom_line(linetype=1) 
# pa <- pa + + scale_color_gradient(low="blue", high="red")
pa <- pa  + facet_wrap(~alpha_o, ncol=2) + ggtitle("Soil water salt mass [g] for varying alphas and lambdas") + theme(plot.title = element_text(lineheight=.8, face="bold"))
pa  
```

# Comparing results
```{r}
# Biomass without salt
# summary(lambda_sum_woSalt$P)
# Biomass with salt
summary(lambda_sum$P)
#Soil moisture without salt
# summary(lambda_sum_woSalt$M)
#Soil moisture with salt
summary(lambda_sum$M)
summary(lambda_sum$Svir)
# summary(1+lambda_sum$Svir)
# summary(-lambda_sum$Svir*n*Zr)

```
